version: "3"

vars:
    PHP: php -d memory_limit=-1
    DIR_WEBSITE: "{{.TASKFILE_DIR}}/dist/website"

tasks:

    #
    # SETUP
    #
    setup:
        desc: "Setups all code style related things."
        cmds:
            -   task: setup-grumphp

    setup-grumphp:
        desc: "Setup grumphp as git hook to run grump on every git commit."
        cmd: |
            cd "{{.DIR_WEBSITE}}"
            vendor/bin/grumphp git:init

    deinit-grumphp:
        desc: "Deinits grumphp and removes git hook."
        cmd: |
            cd "{{.DIR_WEBSITE}}"
            vendor/bin/grumphp git:deinit

    #
    # CHECK
    #
    check:
        desc: Runs all checks configured in grumphp config
        cmd: |
            cd "{{.DIR_WEBSITE}}"
            vendor/bin/grumphp run

    fix:
        desc: Tries to fix everything and runs grumphp afterwards
        cmds:
            -   task: php-cs-fixer
            -   task: twig
            -   task: check

    #
    # FIX - Rector
    #
    rector:
        desc: Runs rector
        cmd: |
            cd "{{.DIR_WEBSITE}}"
            vendor/bin/rector process

    rector--dry:
        desc: Runs rector in dry mode
        cmd: |
            cd "{{.DIR_WEBSITE}}"
            vendor/bin/rector process --dry-run

    rector-list-rules:
        desc: List all configures rules for rector
        cmd: |
            cd "{{.DIR_WEBSITE}}"
            vendor/bin/rector process list-rules

    rector-cc:
        desc: Clears rector cache
        dir: "{{.DIR_WEBSITE}}"
        preconditions:
            -   sh: "[ -f vendor/bin/rector ]"
                msg: "Please run in APP_ENV=dev mode and run setup"
        cmd: "vendor/bin/rector process --dry-run --clear-cache"

    #
    # FIX - PHP-CS-Fixer
    #
    php-cs-fixer:
        desc: Runs php-cs-fixer and fix automatically
        cmd: |
            cd "{{.DIR_WEBSITE}}"
            vendor/bin/php-cs-fixer fix

    php-cs-fixer--dry:
        desc: Runs php-cs-fixer in dry mode
        cmd: |
            cd "{{.DIR_WEBSITE}}"
            vendor/bin/php-cs-fixer fix --dry-run --verbose

    #
    # FIX - phpcbf
    #
    phpcbf:
        desc: Runs phpcbf
        cmd: |
            cd "{{.DIR_WEBSITE}}"
            vendor/bin/phpcbf

    #
    # FIX - PHPStan
    #
    phpstan:
        desc: Runs PHPStan
        cmd: |
            cd "{{.DIR_WEBSITE}}"
            vendor/bin/phpstan analyse

    phpstan-cc:
        desc: Clears PHPStan cache
        cmd: |
            cd "{{.DIR_WEBSITE}}"
            vendor/bin/phpstan clear-result-cache

    #
    # FIX - Twig-CS-Fixer
    #
    twig:
        desc: Runs twig-cs-fixer and fix automatically
        cmd: |
            cd "{{.DIR_WEBSITE}}"
            vendor/bin/twig-cs-fixer lint --fix

    twig--dry:
        desc: Runs twig-cs-fixer in dry mode
        cmd: |
            cd "{{.DIR_WEBSITE}}"
            vendor/bin/twig-cs-fixer lint
