version: "3"

vars:
    #
    # DIR_WEBSITE is resolved in this order:
    # 1. Task variable (e.g. task cs:test DIR_WEBSITE=...)
    # 2. Environment variable (e.g. export DIR_WEBSITE=...)
    # 3. Default to /dist/website relative to this Taskfile
    #
    DIR_WEBSITE: '{{.DIR_WEBSITE | default (env "DIR_WEBSITE") | default (print .TASKFILE_DIR "/dist/website") | clean}}'
    PHP: php -d memory_limit=-1

env:
    # This options is needed for php-cs-fixer and php 8.4 compatibility.
    # Delete this if php-cs-fixer is updated.
    # Issue: https://github.com/PHP-CS-Fixer/PHP-CS-Fixer/milestone/173
    PHP_CS_FIXER_IGNORE_ENV: 1

tasks:

    #
    # SETUP
    #
    setup:
        desc: "Setups all code style related things."
        cmds:
            -   task: setup-grumphp
                internal: true

    setup-grumphp:
        desc: "Setup grumphp as git hook to run grump on every git commit."
        cmd: "{{.DIR_WEBSITE}}/vendor/bin/grumphp git:init"

    deinit-grumphp:
        desc: "Deinits grumphp and removes git hook."
        cmd: "{{.DIR_WEBSITE}}/vendor/bin/grumphp git:deinit"

    #
    # CHECK
    #
    check:
        desc: Runs all checks configured in grumphp config
        cmds:
            - "{{.DIR_WEBSITE}}/vendor/bin/grumphp run"

    fix:
        desc: Tries to fix everything and runs grumphp afterwards
        cmds:
            -   task: php-cs-fixer
            -   task: twig
            -   task: check

    #
    # FIX - Rector
    #
    rector:
        desc: Runs rector
        cmd: "{{.DIR_WEBSITE}}/vendor/bin/rector process"

    rector--dry:
        desc: Runs rector in dry mode
        cmd: "{{.DIR_WEBSITE}}/vendor/bin/rector process --dry-run"

    rector-list-rules:
        desc: List all configures rules for rector
        cmd: "{{.DIR_WEBSITE}}/vendor/bin/rector process list-rules"

    rector-cc:
        desc: Clears rector cache
        preconditions:
            -   sh: "[ -f {{.DIR_WEBSITE}}/vendor/bin/rector ]"
                msg: "Please run in APP_ENV=dev mode and run setup"
        cmd: "{{.DIR_WEBSITE}}/vendor/bin/rector process --dry-run --clear-cache"

    #
    # FIX - PHP-CS-Fixer
    #
    php-cs-fixer:
        desc: Runs php-cs-fixer and fix automatically
        cmd: "{{.DIR_WEBSITE}}/vendor/bin/php-cs-fixer fix"

    php-cs-fixer--dry:
        desc: Runs php-cs-fixer in dry mode
        cmd: "{{.DIR_WEBSITE}}/vendor/bin/php-cs-fixer fix --dry-run --verbose"

    #
    # FIX - phpcbf
    #
    phpcbf:
        desc: Runs phpcbf
        cmd: "{{.DIR_WEBSITE}}/vendor/bin/phpcbf"

    #
    # FIX - PHPStan
    #
    phpstan:
        desc: Runs PHPStan
        cmd: "{{.DIR_WEBSITE}}/vendor/bin/phpstan analyse"

    phpstan-cc:
        desc: Clears PHPStan cache
        cmd: "{{.DIR_WEBSITE}}/vendor/bin/phpstan clear-result-cache"

    #
    # FIX - Twig-CS-Fixer
    #
    twig:
        desc: Runs twig-cs-fixer and fix automatically
        cmd: "{{.DIR_WEBSITE}}/vendor/bin/twig-cs-fixer lint --fix"

    twig--dry:
        desc: Runs twig-cs-fixer in dry mode
        cmd: "{{.DIR_WEBSITE}}/vendor/bin/twig-cs-fixer lint"
